<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <!-- Main CSS File -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/plugins/owl-carousel/owl.carousel.css">
    <link rel="stylesheet" href="/assets/css/plugins/magnific-popup/magnific-popup.css">
    <link rel="stylesheet" href="/assets/css/plugins/nouislider/nouislider.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="stylesheet" href="/css/styles/user/orderDetails.css">

    
</head>
<body>

    <header class="header header-intro-clearance header-4">
        <div class="header-top">
            <div class="container">
                <div class="header-left">
                    <a href="tel:#"><i class="icon-phone"></i>Call: +0123 456 789</a>
                </div><!-- End .header-left -->

                <div class="header-right">

                    <ul class="top-menu">
                        <li>
                            <a href="#">Links</a>
                            <ul>
                                <li>
                                    <div class="header-dropdown">
                                        <a href="#">USD</a>
                                        <div class="header-menu">
                                            <ul>
                                                <!-- <li><a href="#">Eur</a></li>
                                                <li><a href="#">Usd</a></li> -->
                                            </ul>
                                        </div><!-- End .header-menu -->
                                    </div>
                                </li>
                                <li>
                                    <div class="header-dropdown">
                                        <a href="#">English</a>
                                        <div class="header-menu">
                                            <ul>
                                                <!-- <li><a href="#">English</a></li>
                                                <li><a href="#">French</a></li>
                                                <li><a href="#">Spanish</a></li> -->
                                            </ul>
                                        </div><!-- End .header-menu -->
                                    </div>
                                </li>
                                <!-- <% if(user){%>

                                    <li><a href="/logout">Logout</a></li>
                              <%  }else{%>

                                <li><a href="http://localhost:3000/signin">Sign in / Sign up</a></li>
                            <%  } %> -->
                            </ul>
                        </li>
                    </ul><!-- End .top-menu -->
                </div><!-- End .header-right -->

            </div><!-- End .container -->
        </div><!-- End .header-top -->

        <div class="header-middle">
            <div class="container">
                <div class="header-left">
                    <button class="mobile-menu-toggler">
                        <span class="sr-only">Toggle mobile menu</span>
                        <i class="icon-bars"></i>
                    </button>
                    
                    <a href="index.html" class="logo">
                       <h1>Clicon</h1>
                    </a>
                </div><!-- End .header-left -->

             

                 <div class="header-right">
                    <div class="compare-dropdown">
                        <a href="#" title="Compare Products" aria-label="Compare Products">
                            <div class="icon">
                                <i class="icon-random" style="font-size: 24px;"></i>
                            </div>
                            <p>Compare</p>
                        </a>
                    </div>
                    <!-- End .compare-dropdown -->

                    <div class="wishlist">
                        <a href="/wishlist" title="Wishlist">
                            <div class="icon">
                                <i class="icon-heart-o"></i>
                                
                            </div>
                            <p>Wishlist</p>
                        </a>
                    </div><!-- End .compare-dropdown -->

                    <div class="cart-dropdown">
                        <a href="/cart" class="dropdown-toggle" role="button" data-display="static">
                            <div class="icon">
                                <i class="icon-shopping-cart"></i>
                            </div>
                            <p>Cart</p>
                        </a>
                    </div><!-- End .cart-dropdown -->
                    


                   
                     

                </div>


            </div><!-- End .container -->
        </div><!-- End .header-middle -->

        <div class="header-bottom sticky-header">
            <div class="container">
                <div class="header-left">
                    
                </div>

                <div class="header-center">
                    <nav class="main-nav" style="display: flex; align-items: center;">
                        <ul class="menu" style="list-style: none; display: flex; align-items: center; margin: 0; padding: 0; width: 100%;">
                            <li  style="margin: 0 10px;">
                                <a href="/" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">Home</a>
                            </li>
                            <li style="margin: 0 10px;" class="megamenu-container active">
                                <a href="/productlist" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">Shop</a>
                            </li>
                            <li style="margin: 0 10px;">
                                <a href="blog.html" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">About</a>
                            </li>
                            <li style="margin: 0 10px;">
                                <a href="elements-list.html" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">Contact</a>
                            </li>
                           
                        </ul>
                    </nav>
                </div>

                
                <div class="header-right">
                    <i class="la la-lightbulb-o"></i><p>Clearance<span class="highlight">&nbsp;Up to 30% Off</span></p>
                </div>
            </div><!-- End .container -->
        </div><!-- End .header-bottom -->
    </header>

<div class="container py-5">
    <!-- Order Header -->
    <div class="order-header mb-4">
        <div class="row align-items-center position-relative">
            <div class="col-md-8">
                <h4 class="mb-2">Order #<%= order?.customOrderId %></h4>
                <p class="mb-0">Placed on <%= order?.createdAt.toDateString() %></p>
            </div>
            <div class="col-md-4 d-flex justify-content-end">
                <div class="text-end">
                  
                    <button id="retryPaymentButton" 
                        style="
                            display: none;
                            background: linear-gradient(135deg, #0056b3 0%, #007bff 100%);
                            color: white;
                            font-size: 14px;
                            padding: 8px 20px;
                            border: none;
                            border-radius: 25px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.2);
                            font-weight: 500;
                            position: relative;
                            overflow: hidden;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0, 123, 255, 0.3)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0, 123, 255, 0.2)';">
                        <i class="fas fa-sync-alt" style="margin-right: 6px;"></i>Complete Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Status Timeline -->
    <div class="order-timeline">
        <ul class="timeline">
            <!-- Pending Status -->
            <li class="timeline-item <%= item?.shippingDetails.status === 'Pending' ? 'active' : '' %>">
                <span class="timeline-icon <%= item?.shippingDetails.status === 'Pending' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-hourglass-half"></i>
                </span>
                <div class="timeline-content">
                    <strong>Pending</strong>
                    <p><%= order?.createdAt.toDateString() %></p>
                </div>
            </li>

            <!-- Processing Status -->
            <li class="timeline-item <%= item?.shippingDetails.status === 'Processing' ? 'active' : '' %>">
                <span class="timeline-icon <%= item?.shippingDetails.status === 'Processing' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-cogs"></i>
                </span>
                <div class="timeline-content">
                    <strong>Processing</strong>
                    <!-- <p><%= order.updatedAt %></p> -->
                </div>
            </li>

            <!-- Shipped Status -->
            <li class="timeline-item <%= item?.shippingDetails.status === 'Shipped' ? 'active' : '' %>">
                <span class="timeline-icon <%= item?.shippingDetails.status === 'Shipped' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-truck"></i>
                </span>
                <div class="timeline-content">
                    <strong>Shipped</strong>
                    <p><%= item?.shippingDetails.updatedAt %></p>
                </div>
            </li>

            <!-- Delivered Status -->
            <li class="timeline-item <%= item.shippingDetails.status === 'Delivered' ? 'active' : '' %>">
                <span class="timeline-icon <%= item.shippingDetails.status === 'Delivered' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-check-circle"></i>
                </span>
                <div class="timeline-content">
                    <strong>Delivered</strong>
                    <p><%= item?.shippingDetails.updatedAt %></p>
                </div>
            </li>

            <!-- Cancelled Status -->
            <li class="timeline-item <%= item.shippingDetails.status === 'Cancelled' ? 'active' : '' %>">
                <span class="timeline-icon <%= item.shippingDetails.status === 'Cancelled' ? 'bg-danger' : 'bg-danger' %>">
                    <i class="fas fa-times-circle"></i>
                </span>
                <div class="timeline-content">
                    <strong>Cancelled</strong>
                    <p><%= item?.shippingDetails.cancelledDate %></p>
                </div>
            </li>
        </ul>
    </div>

    <div class="row">
        <!-- Product Details -->
        <div class="col-lg-8">
            <div class="product-card mb-4">
                <% if (order.paymentMethod === "razorpay" && order.paymentStatus === "Pending") { %>
                    <div style="
                        background-color: #fff3cd;
                        color: #856404;
                        padding: 12px;
                        border-radius: 8px;
                        margin-bottom: 15px;
                        border: 1px solid #ffeeba;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    ">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-exclamation-circle" style="margin-right: 10px; font-size: 18px;"></i>
                            <span style="font-weight: 500;"> Complete the entire order payment to proceed</span>
                        </div>
                    </div>
                <% } %>
                <h5 class="mb-4">Product Details</h5>
                <div class="d-flex align-items-center">
                    <img src="/uploads/<%= item?.productId.image[0] %>" class="product-image me-4" alt="Product">
                 
                    <% 
                    const originalPrice = parseFloat(item.price) || 0;
                    const discountMatch = item.offer ? item.offer.match(/\d+/) : null;
                    const discountPercentage = discountMatch ? parseFloat(discountMatch[0]) : 0;
                    const discountedPrice = originalPrice - (originalPrice * discountPercentage / 100);
                    
                    const total = (discountedPrice*item.quantity)-(order?.coupon?.discountValue||0)
                  %>
                         
                    <div>
                        <h5 class="mb-2"><%= item?.productId.productname %></h5>
                        <p class="text-muted mb-2"><%= item?.productId.description %></p>
                        <span class="price-tag ">₹<%= Math.floor(discountedPrice)  %></span>
                        <p class="card-text"><strong>Estimated Arrival:</strong> <%= new Date(new Date(order.orderDate).setDate(new Date(order.orderDate).getDate() + 7)).toLocaleDateString() %></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipping Details -->
        <div class="col-lg-4">
            <div class="shipping-card">
                <h5 class="mb-3">Shipping Details</h5>
                <h6><%= order?.customerId.name %></h6>

                <p class="text-muted">
                    <% if (order?.billingAddress) { %>
                        <%= order?.billingAddress.street %><br>
                        <%= order?.billingAddress.city %>, <%= order.billingAddress.state %> - <%= order.billingAddress.postcode %>
                    <% } else { %>
                        <span class="text-danger">Billing address not available</span>
                    <% } %>
                </p>
                <div class="d-flex align-items-center">
                    <i class="fas fa-phone-alt me-2 text-primary"></i>
                    <span><%= order?.billingAddress.phone %></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this right below the Shipping Details div inside the col-lg-4 column -->
<div class="order-summary-card mb-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Order Summary</h5>
    </div>
    <div class="row mb-2">
        <div class="col-6">Quantity:</div>
        <div class="col-6 text-end"><%= item.quantity %></div>
    </div>
    <div class="row mb-2">
        <div class="col-6">Unit Price:</div>
        <div class="col-6 text-end">₹<%= originalPrice %></div>
    </div>
    <div class="row mb-2">
        <div class="col-6"> Subtotal:</div>
        <div class="col-6 text-end">₹<%= (item.quantity * originalPrice).toFixed(2) %></div>
    </div>
   
    <div class="row mb-2">
        <div class="col-6"> Unit Price After Discount:</div>
        <div class="col-6 text-end">₹<%= Math.floor(discountedPrice)  %></div>
    </div>

    <div class="row mb-2">
        <div class="col-6">Coupon Applied:</div>
        <div class="col-6 text-end">-₹<%= item.coupons ||0 %></div>
    </div>

    <div class="row pt-3 border-top">
        <div class="col-6 fw-bold">Total:</div>
        <div class="col-6 text-end fw-bold">
            <% if (order.paymentMethod && (order.paymentStatus === "Paid" || order.paymentMethod === "Wallet")) { %>
                <div style="color: rgb(113, 113, 34);">Paid </div> ₹ <%= Math.floor(total)  %>
            <% } else { %>
                ₹ <%= Math.floor(total)  %>
            <% } %>


            <input type="hidden" id="razorId" value="<%= order.razorId %>">
            <input type="hidden" id="paymentMethod" value="<%= order.paymentMethod %>">
            <input type="hidden" id="paymentStatus" value="<%= order.paymentStatus %>">

        </div>
    </div>
</div>

<!-- Download Invoice Button -->
<% if (item?.shippingDetails?.status === 'Delivered') { %>

    <div class="order-summary-card mb-4 text-end">
        <button onclick="downloadInvoice(this)" 
                class="download-invoice-btn"
                data-order='<%- JSON.stringify({
                    orderId: order?._id,
                    customOrderId: order?.customOrderId,
                    orderDate: order?.orderDate,
                    billingAddress: order?.billingAddress,
                    totalAmount: order?.totalAmount,
                    paymentMethod: order?.paymentMethod,
                    items: order?.items?.map(item => ({
                        productName: item?.productId?.productname,
                        quantity: item?.quantity,
                        price: item?.price,
                        offer: item?.offer,
                        discountedPrice: item?.price - (item?.price * (parseInt(item?.offer) || 0) / 100),
                        total: (item?.price - (item?.price * (parseInt(item?.offer) || 0) / 100)) * item?.quantity
                    }))
                }) %>'>
            <i class="fas fa-download"></i> Download Invoice
        </button>
    </div>

<%}%>



<div class="modal fade" id="returnModal-<%= item?.productId._id %>" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Added modal-lg for larger modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="returnModalLabel">Return Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="returnForm-<%= item?.productId._id %>" action="/returns" method="post">
                    <input type="hidden" name="orderId" value="<%= order?._id %>">
                    <input type="hidden" name="productId" value="<%= item?.productId._id %>">
                    <input type="hidden" name="quantity" value="<%= item?.quantity %>">
                    
                    <label for="returnReason" class="form-label">Select Return Reason:</label>
                    <select class="form-select form-control-lg" name="reason" required> <!-- Larger select input -->
                        <option value="">-- Select Reason --</option>
                        <option value="Received a defective product">Received a defective product</option>
                        <option value="Wrong item received">Wrong item received</option>
                        <option value="Product not as described">Product not as described</option>
                        <option value="Missing accessories or parts">Missing accessories or parts</option>
                    </select>
                    <button type="submit" class="btn btn-primary" >Submit Request</button>

                </form>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>



    <!-- Buttons -->
    <div class="button-container">
        <% if (item.shippingDetails?.status === "Cancelled") { %>
            <button class="btn btn-secondary btn-cancelled" style="display: none;">Cancelled</button>
        <% } else if (item?.shippingDetails?.status !== "Delivered") { %>
            <% if (order.paymentMethod === "razorpay" && order.paymentStatus === "Pending") { %>
                <button class="btn btn-danger btn-cancel" style="display: none;"></button>
            <% } else { %>
                <button class="btn btn-danger btn-cancel" onclick="confirmCancel('<%= order?._id %>', '<%= item?.productId._id %>', '<%= item?.quantity %>')">
                    Cancel
                </button>
            <% } %>
        <% } else if (item?.shippingDetails?.status === "Delivered") { %>
            <% 
                let deliveryDate = new Date(item.shippingDetails.createdAt);
                let currentDate = new Date();
                let returnDisabled = (currentDate - deliveryDate) > 7 * 24 * 60 * 60 * 1000;
            %>
    
            <% if (returns.length > 0) { %>
                <button class="btn btn-success btn-returned">Returned</button> 
            <% } else { %>
                <button class="btn btn-warning btn-return" 
                    data-bs-toggle="modal" 
                    data-bs-target="#returnModal-<%= item?.productId._id %>"
                    <% if (returnDisabled) { %> disabled <% } %>
                >
                    Return
                </button>
            <% } %>
        <% } %>
    </div>
    
        <p id="retryPaymentMessage" style="color: #dc3545; font-weight: bold; margin-bottom: 10px; display: none;">
        
        </p>
        
        <button id="retryPaymentButton" 
            style="
                display: none;
                background-color: #007bff;
                color: white;
                font-size: 14px;
                padding: 10px 15px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                z-index: 1;
            "
            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.3)'"
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
            <span style="
                position: relative;
                z-index: 2;
                display: flex;
                align-items: center;
                gap: 5px;
            ">
                <span class="rotate-icon" style="
                    display: inline-block;
                    transition: transform 0.3s ease;
                ">🔄</span>
                Retry Payment
            </span>
        </button>
    
    <div class="text-center mt-4">
        <a href="/profile/<%= user?._id %>" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Orders
        </a>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    const { jsPDF } = window.jspdf;
</script>

<script src="/scripts/user/order-details.js"></script>


</body>
</html>
