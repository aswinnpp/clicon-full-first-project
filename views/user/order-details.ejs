<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <!-- Main CSS File -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/plugins/owl-carousel/owl.carousel.css">
    <link rel="stylesheet" href="/assets/css/plugins/magnific-popup/magnific-popup.css">
    <link rel="stylesheet" href="/assets/css/plugins/nouislider/nouislider.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>


    .invoice-section {
        width: 100%;
        max-width: 800px;
        margin: auto;
        padding: 20px;
        background-color: #fff;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: left;
    }
    th {
        background-color: #f8f9fa;
        text-align: center;
    }


        :root {
            --primary-color: #8187a8;
            --success-color: #0abf53;
            --text-color: #1f2937;
            --border-radius: 12px;
        }
        .order-summary-card {
    border-radius: var(--border-radius);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    background: white;
    margin-bottom: 1rem;
}

.order-summary-card .row {
    margin: 8px 0;
    align-items: center;
}

.border-top {
    border-top: 1px solid #e5e7eb !important;
}

        body {
            background-color: #f9fafb;
            color: var(--text-color);
        }

        .order-header {
            background: linear-gradient(135deg, #c6bebe 0%, #edecf0 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .product-image {
            border-radius: var(--border-radius);
            width: 150px;
            height: 150px;
            object-fit: cover;
        }

        .price-tag {
            background-color: #f3f4f6;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: 600;
        }

        .shipping-card, .product-card {
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            background: white;
        }

        .timeline {
            display: flex;
            list-style: none;
            padding-left: 0;
            margin-top: 20px;
            position: relative;
            justify-content: space-between;
        }

        .timeline-item {
            position: relative;
            width: 18%;
            opacity: 0.6;
            transition: opacity 0.5s ease;
            text-align: center;
        }

        .timeline-item.active {
            opacity: 1;
        }

        .timeline-item .timeline-icon {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: -20px;
            width: 30px;
            height: 30px;
            background-color: #ddd;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            color: white;
        }

        .timeline-item .timeline-content {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }

        .timeline-item .timeline-content p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        .timeline-item .timeline-content strong {
            font-weight: bold;
        }

        /* Active step styles */
        .timeline-item.active .timeline-icon {
            background-color: #28a745;
        }

        .timeline-item.active .timeline-content {
            background-color: #e9f7ef;
        }

        .timeline-item .timeline-icon.bg-secondary {
            background-color: #ddd;
        }

        .button-container {
            margin-top: 20px;
            text-align: center;
        }

        .btn-cancel, .btn-return {
            margin: 5px;
        }

        .btn-return:disabled {
            background-color: #ccc;
        }

        .invoice-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .invoice-section h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .invoice-details {
            margin-bottom: 15px;
        }

        .invoice-details p {
            margin: 5px 0;
        }

        .download-invoice-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .download-invoice-btn:hover {
            background-color: #218838;
        }

        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>

    <header class="header header-intro-clearance header-4">
        <div class="header-top">
            <div class="container">
                <div class="header-left">
                    <a href="tel:#"><i class="icon-phone"></i>Call: +0123 456 789</a>
                </div><!-- End .header-left -->

                <div class="header-right">

                    <ul class="top-menu">
                        <li>
                            <a href="#">Links</a>
                            <ul>
                                <li>
                                    <div class="header-dropdown">
                                        <a href="#">USD</a>
                                        <div class="header-menu">
                                            <ul>
                                                <!-- <li><a href="#">Eur</a></li>
                                                <li><a href="#">Usd</a></li> -->
                                            </ul>
                                        </div><!-- End .header-menu -->
                                    </div>
                                </li>
                                <li>
                                    <div class="header-dropdown">
                                        <a href="#">English</a>
                                        <div class="header-menu">
                                            <ul>
                                                <!-- <li><a href="#">English</a></li>
                                                <li><a href="#">French</a></li>
                                                <li><a href="#">Spanish</a></li> -->
                                            </ul>
                                        </div><!-- End .header-menu -->
                                    </div>
                                </li>
                                <!-- <% if(user){%>

                                    <li><a href="/logout">Logout</a></li>
                              <%  }else{%>

                                <li><a href="http://localhost:3000/signin">Sign in / Sign up</a></li>
                            <%  } %> -->
                            </ul>
                        </li>
                    </ul><!-- End .top-menu -->
                </div><!-- End .header-right -->

            </div><!-- End .container -->
        </div><!-- End .header-top -->

        <div class="header-middle">
            <div class="container">
                <div class="header-left">
                    <button class="mobile-menu-toggler">
                        <span class="sr-only">Toggle mobile menu</span>
                        <i class="icon-bars"></i>
                    </button>
                    
                    <a href="index.html" class="logo">
                       <h1>Clicon</h1>
                    </a>
                </div><!-- End .header-left -->

             

                 <div class="header-right">
                    <div class="compare-dropdown">
                        <a href="#" title="Compare Products" aria-label="Compare Products">
                            <div class="icon">
                                <i class="icon-random" style="font-size: 24px;"></i>
                            </div>
                            <p>Compare</p>
                        </a>
                    </div>
                    <!-- End .compare-dropdown -->

                    <div class="wishlist">
                        <a href="/wishlist" title="Wishlist">
                            <div class="icon">
                                <i class="icon-heart-o"></i>
                                
                            </div>
                            <p>Wishlist</p>
                        </a>
                    </div><!-- End .compare-dropdown -->

                    <div class="cart-dropdown">
                        <a href="/cart" class="dropdown-toggle" role="button" data-display="static">
                            <div class="icon">
                                <i class="icon-shopping-cart"></i>
                            </div>
                            <p>Cart</p>
                        </a>
                    </div><!-- End .cart-dropdown -->
                    


                   
                     

                </div>


            </div><!-- End .container -->
        </div><!-- End .header-middle -->

        <div class="header-bottom sticky-header">
            <div class="container">
                <div class="header-left">
                    
                </div>

                <div class="header-center">
                    <nav class="main-nav" style="display: flex; align-items: center;">
                        <ul class="menu" style="list-style: none; display: flex; align-items: center; margin: 0; padding: 0; width: 100%;">
                            <li  style="margin: 0 10px;">
                                <a href="/" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">Home</a>
                            </li>
                            <li style="margin: 0 10px;" class="megamenu-container active">
                                <a href="/productlist" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">Shop</a>
                            </li>
                            <li style="margin: 0 10px;">
                                <a href="blog.html" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">About</a>
                            </li>
                            <li style="margin: 0 10px;">
                                <a href="elements-list.html" class="sff-with-ul" style="text-decoration: none; color: #000; font-size: 16px;">Contact</a>
                            </li>
                           
                        </ul>
                    </nav>
                </div>

                
                <div class="header-right">
                    <i class="la la-lightbulb-o"></i><p>Clearance<span class="highlight">&nbsp;Up to 30% Off</span></p>
                </div>
            </div><!-- End .container -->
        </div><!-- End .header-bottom -->
    </header>

<div class="container py-5">
    <!-- Order Header -->
    <div class="order-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-2">Order #<%= order?._id %></h4>
                <p class="mb-0">Placed on <%= order?.createdAt.toDateString() %></p>
            </div>
        </div>
    </div>

    <!-- Order Status Timeline -->
    <div class="order-timeline">
        <ul class="timeline">
            <!-- Pending Status -->
            <li class="timeline-item <%= item?.shippingDetails.status === 'Pending' ? 'active' : '' %>">
                <span class="timeline-icon <%= item?.shippingDetails.status === 'Pending' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-hourglass-half"></i>
                </span>
                <div class="timeline-content">
                    <strong>Pending</strong>
                    <p><%= order?.createdAt.toDateString() %></p>
                </div>
            </li>

            <!-- Processing Status -->
            <li class="timeline-item <%= item?.shippingDetails.status === 'Processing' ? 'active' : '' %>">
                <span class="timeline-icon <%= item?.shippingDetails.status === 'Processing' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-cogs"></i>
                </span>
                <div class="timeline-content">
                    <strong>Processing</strong>
                    <!-- <p><%= order.updatedAt %></p> -->
                </div>
            </li>

            <!-- Shipped Status -->
            <li class="timeline-item <%= item?.shippingDetails.status === 'Shipped' ? 'active' : '' %>">
                <span class="timeline-icon <%= item?.shippingDetails.status === 'Shipped' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-truck"></i>
                </span>
                <div class="timeline-content">
                    <strong>Shipped</strong>
                    <p><%= item?.shippingDetails.updatedAt %></p>
                </div>
            </li>

            <!-- Delivered Status -->
            <li class="timeline-item <%= item.shippingDetails.status === 'Delivered' ? 'active' : '' %>">
                <span class="timeline-icon <%= item.shippingDetails.status === 'Delivered' ? 'bg-success' : 'bg-secondary' %>">
                    <i class="fas fa-check-circle"></i>
                </span>
                <div class="timeline-content">
                    <strong>Delivered</strong>
                    <p><%= item?.shippingDetails.updatedAt %></p>
                </div>
            </li>

            <!-- Cancelled Status -->
            <li class="timeline-item <%= item.shippingDetails.status === 'Cancelled' ? 'active' : '' %>">
                <span class="timeline-icon <%= item.shippingDetails.status === 'Cancelled' ? 'bg-danger' : 'bg-danger' %>">
                    <i class="fas fa-times-circle"></i>
                </span>
                <div class="timeline-content">
                    <strong>Cancelled</strong>
                    <p><%= item?.shippingDetails.cancelledDate %></p>
                </div>
            </li>
        </ul>
    </div>

    <div class="row">
        <!-- Product Details -->
        <div class="col-lg-8">
            <div class="product-card mb-4">
                <h5 class="mb-4">Product Details</h5>
                <div class="d-flex align-items-center">
                    <img src="/uploads/<%= item?.productId.image[0] %>" class="product-image me-4" alt="Product">
                 
                    <% 
                    const originalPrice = parseFloat(item.price) || 0;
                    const discountMatch = item.offer ? item.offer.match(/\d+/) : null;
                    const discountPercentage = discountMatch ? parseFloat(discountMatch[0]) : 0;
                    const discountedPrice = originalPrice - (originalPrice * discountPercentage / 100);
                    
                    const total = (discountedPrice*item.quantity)-(order?.coupon?.discountValue||0)
                  %>
                         
                    <div>
                        <h5 class="mb-2"><%= item?.productId.productname %></h5>
                        <p class="text-muted mb-2"><%= item?.productId.description %></p>
                        <span class="price-tag ">₹<%= Math.floor(discountedPrice)  %></span>
                        <p class="card-text"><strong>Estimated Arrival:</strong> <%= new Date(new Date(order.orderDate).setDate(new Date(order.orderDate).getDate() + 7)).toLocaleDateString() %></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipping Details -->
        <div class="col-lg-4">
            <div class="shipping-card">
                <h5 class="mb-3">Shipping Details</h5>
                <h6><%= order?.customerId.name %></h6>

                <p class="text-muted">
                    <% if (order?.billingAddress) { %>
                        <%= order?.billingAddress.street %><br>
                        <%= order?.billingAddress.city %>, <%= order.billingAddress.state %> - <%= order.billingAddress.postcode %>
                    <% } else { %>
                        <span class="text-danger">Billing address not available</span>
                    <% } %>
                </p>
                <div class="d-flex align-items-center">
                    <i class="fas fa-phone-alt me-2 text-primary"></i>
                    <span><%= order?.billingAddress.phone %></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this right below the Shipping Details div inside the col-lg-4 column -->
<div class="order-summary-card mb-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Order Summary</h5>
    </div>
    <div class="row mb-2">
        <div class="col-6">Quantity:</div>
        <div class="col-6 text-end"><%= item.quantity %></div>
    </div>
    <div class="row mb-2">
        <div class="col-6">Unit Price:</div>
        <div class="col-6 text-end">₹<%= originalPrice %></div>
    </div>
    <div class="row mb-2">
        <div class="col-6"> Subtotal:</div>
        <div class="col-6 text-end">₹<%= (item.quantity * originalPrice).toFixed(2) %></div>
    </div>
   
    <div class="row mb-2">
        <div class="col-6"> Unit Price After Discount:</div>
        <div class="col-6 text-end">₹<%= Math.floor(discountedPrice)  %></div>
    </div>

    <div class="row mb-2">
        <div class="col-6">Coupon Applied:</div>
        <div class="col-6 text-end">-₹<%= item.coupons ||0 %></div>
    </div>

    <div class="row pt-3 border-top">
        <div class="col-6 fw-bold">Total:</div>
        <div class="col-6 text-end fw-bold">
            <% if (order.paymentMethod && (order.paymentMethod === "razorpay" || order.paymentMethod === "Wallet")) { %>
                <div style="color: rgb(113, 113, 34);">Paid </div> ₹ <%= Math.floor(total)  %>
            <% } else { %>
                ₹ <%= Math.floor(total)  %>
            <% } %>
        </div>
    </div>
</div>

<!-- Download Invoice Button -->
<div class="order-summary-card mb-4 text-end">
    <button onclick="downloadInvoice(this)" 
            class="download-invoice-btn"
            data-order='<%- JSON.stringify({
                orderId: order?._id,
                customOrderId: order?.customOrderId,
                orderDate: order?.orderDate,
                billingAddress: order?.billingAddress,
                totalAmount: order?.totalAmount,
                paymentMethod: order?.paymentMethod,
                items: order?.items?.map(item => ({
                    productName: item?.productId?.productname,
                    quantity: item?.quantity,
                    price: item?.price,
                    offer: item?.offer,
                    discountedPrice: item?.price - (item?.price * (parseInt(item?.offer) || 0) / 100),
                    total: (item?.price - (item?.price * (parseInt(item?.offer) || 0) / 100)) * item?.quantity
                }))
            }) %>'>
        <i class="fas fa-download"></i> Download Invoice
    </button>
</div>

<div class="modal fade" id="returnModal-<%= item?.productId._id %>" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Added modal-lg for larger modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="returnModalLabel">Return Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="returnForm-<%= item?.productId._id %>" action="/returns" method="post">
                    <input type="hidden" name="orderId" value="<%= order?._id %>">
                    <input type="hidden" name="productId" value="<%= item?.productId._id %>">
                    <input type="hidden" name="quantity" value="<%= item?.quantity %>">
                    
                    <label for="returnReason" class="form-label">Select Return Reason:</label>
                    <select class="form-select form-control-lg" name="reason" required> <!-- Larger select input -->
                        <option value="">-- Select Reason --</option>
                        <option value="Received a defective product">Received a defective product</option>
                        <option value="Wrong item received">Wrong item received</option>
                        <option value="Product not as described">Product not as described</option>
                        <option value="Missing accessories or parts">Missing accessories or parts</option>
                    </select>
                    <button type="submit" class="btn btn-primary" >Submit Request</button>

                </form>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>



    <!-- Buttons -->
        <div class="button-container">
            <% if (item.shippingDetails?.status === "Cancelled") { %>
                <button class="btn btn-secondary btn-cancelled" style="display: none;">Cancelled</button>
            <% } else if (item?.shippingDetails?.status !== "Delivered") { %>
                <button class="btn btn-danger btn-cancel" onclick="confirmCancel('<%= order?._id %>', '<%= item?.productId._id %>', '<%= item?.quantity %>')">
                    Cancel
                </button>
            <% } else if (item?.shippingDetails?.status === "Delivered") { %>
                <% 
                    let deliveryDate = new Date(item.shippingDetails.createdAt);
                    let currentDate = new Date();
                    let returnDisabled = (currentDate - deliveryDate) > 7 * 24 * 60 * 60 * 1000;
                %>


                
                <% if (returns.length >0) { %>
                    <button class="btn btn-success btn-returned">Returned</button> 
                <% } else { %>
                    <button class="btn btn-warning btn-return" 
                        data-bs-toggle="modal" 
                        data-bs-target="#returnModal-<%= item?.productId._id %>"
                        <% if (returnDisabled) { %> disabled <% } %>
                    >
                        Return
                    </button>
                <% } %>
            <% } %>
        </div>
        
    
    
    <div class="text-center mt-4">
        <a href="/profile/<%= user?._id %>" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Orders
        </a>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    const { jsPDF } = window.jspdf;
</script>

<script>
   
   function confirmCancel(orderId, productId ,quantity) {
    
        Swal.fire({
    title: "Are you sure?",
    html: `
        <p>You are about to cancel this order.</p>
        <p>Please select a reason for cancellation:</p>
        <div style="text-align: left; margin-top:50px;">
            <input type="radio" name="cancelReason" value="Color Issue" id="colorIssue">
            <label for="colorIssue">Color Issue</label><br>
            <input type="radio" name="cancelReason" value="Damage" id="damage">
            <label for="damage">Damage</label><br>
            <input type="radio" name="cancelReason" value="Other" id="other">
            <label for="other">Other</label><br>
        </div>
    `,
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "Yes, cancel it!",
    preConfirm: () => {
        const selectedReason = document.querySelector('input[name="cancelReason"]:checked');
        if (!selectedReason) {
            Swal.showValidationMessage("Please select a cancellation reason");
            return false;
        }
        return selectedReason.value;
    }
}).then((result) => {
    if (result.isConfirmed) {
        const cancelReason = result.value;
        window.location.href = `/update-order-status?orderId=${orderId}&productId=${productId}&newStatus=Cancelled&quantity=${quantity}&reason=${encodeURIComponent(cancelReason)}`;
    }
});
    }
    
    
    
    
    function downloadInvoice(button) {
    const orderData = JSON.parse(button.dataset.order);
    const doc = new jsPDF();

    // Set document properties¹
    doc.setProperties({
        title: `Invoice-${orderData.customOrderId}`,
        subject: 'Clicon Store Invoice',
        author: 'Clicon Store',
        keywords: 'invoice, order, purchase'
    });

    // Simple white background²
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 0, 210, 297, 'F');
    
    // Simple header³
    doc.setFillColor(41, 128, 185);
    doc.rect(0, 0, 210, 20, 'F');
    
    // Title⁴
    doc.setFont("helvetica", "bold");
    doc.setFontSize(24);
    doc.setTextColor(255, 255, 255);
    doc.text("INVOICE", 105, 14, { align: "center" });
    
    // Reset text color⁵
    doc.setTextColor(0, 0, 0);

    // Company info⁶
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Clicon Store", 15, 30);
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text("Main Street, Kerala, India", 15, 36);
    
    // Invoice info⁷
    doc.setFont("helvetica", "bold");
    doc.text("Invoice Number:", 140, 30);
    doc.setFont("helvetica", "normal");
    doc.text(`INV-${Math.floor(Math.random() * 1000000).toString().padStart(6, '0')}`, 180, 30);
    
    doc.setFont("helvetica", "bold");
    doc.text("Date:", 140, 36);
    doc.setFont("helvetica", "normal");
    doc.text(new Date(orderData.orderDate).toLocaleDateString(), 180, 36);
    
    doc.setFont("helvetica", "bold");
    doc.text("Payment Method:", 140, 42);
    doc.setFont("helvetica", "normal");
    doc.text(orderData.paymentMethod, 180, 42);

    // Separator line⁸
    doc.setDrawColor(200, 200, 200);
    doc.line(15, 48, 195, 48);

    // Customer info⁹
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Bill To:", 15, 58);
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`${orderData.billingAddress?.name || ''}`, 15, 65);
    doc.text(`${orderData.billingAddress?.street || ''}`, 15, 71);
    doc.text(`${orderData.billingAddress?.city || ''}, ${orderData.billingAddress?.state || ''}`, 15, 77);
    doc.text(`${orderData.billingAddress?.postcode || ''}`, 15, 83);
    doc.text(`${orderData.billingAddress?.country || 'India'}`, 15, 89);
    doc.text(`Phone: ${orderData.billingAddress?.phone || ''}`, 15, 95);
    doc.text(`Email: ${orderData.billingAddress?.email || ''}`, 15, 101);

    // Separator line¹⁰
    doc.line(15, 108, 195, 108);

    // Table Headers¹¹
    let startY = 118;
    doc.setFillColor(240, 240, 240);
    doc.rect(15, startY - 6, 180, 10, 'F');
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);

    doc.text("Product", 20, startY);
    doc.text("Qty", 100, startY);
    doc.text("Price", 120, startY);
    doc.text("Discount", 145, startY);
    doc.text("Total", 175, startY);
    
    // Table content¹²
    doc.setFont("helvetica", "normal");
    let y = startY + 10;
    let subtotal = 0;

    orderData.items.forEach((item) => {
        const unitPrice = Math.floor(parseFloat(item.price)) || 0;
        const discount = item.offer ? parseFloat(item.offer) : 0;
        const discountAmount = Math.floor((unitPrice * discount) / 100);
        const netPrice = Math.floor(unitPrice - discountAmount);
        const total = Math.floor(netPrice * parseInt(item.quantity));
        subtotal += total;

        // Table Data¹³
        doc.text(item.productName || '', 20, y, { maxWidth: 75 });
        doc.text(item.quantity.toString(), 100, y);
        doc.text("₹" + unitPrice.toString(), 120, y);
        doc.text(Math.floor(discount).toString() + "%", 145, y);
        doc.text("₹" + total.toString(), 175, y);

        y += 10;
        
        // Add line between items¹⁴
        doc.setDrawColor(230, 230, 230);
        doc.line(15, y - 5, 195, y - 5);
    });

    // Total Section¹⁵
    y += 10;
    doc.setFont("helvetica", "bold");
    doc.text("Total Amount:", 140, y);
    doc.text("₹" + Math.floor(subtotal).toString(), 175, y);

    // Footer¹⁶
    doc.setDrawColor(41, 128, 185);
    doc.setLineWidth(0.5);
    doc.line(15, y + 15, 195, y + 15);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.text("This is a computer-generated invoice. No signature required.", 105, y + 25, { align: "center" });
    
    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    doc.setTextColor(41, 128, 185);
    doc.text("Thank you for shopping with Clicon Store!", 105, y + 35, { align: "center" });

    // Save PDF¹⁷
    doc.save(`invoice-${orderData.customOrderId}.pdf`);
}

</script>
</body>
</html>
