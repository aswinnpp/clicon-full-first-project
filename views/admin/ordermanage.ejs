<%- include('../partials/admin/header') %>

<link rel="stylesheet" href="../../css/styles/categorymanage.css">
<!-- Main Content -->
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4 d-md-none">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Order Management</a>
      <button class="navbar-toggler custom-toggler" id="menuBtn" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>
  
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Order Status</h1>
  </div>

  <div class="row mb-3" style="margin-top:80px;">
    <div class="col">
      <div class="input-group">
        <input type="text" class="form-control" id="categorySearch" placeholder="Search categories...">
        <button class="btn btn-primary" type="button">Search</button>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Customer Name</th>
          <th>Product Name</th>
          <th>Order Date</th> 
          <th>Total Amount</th>
          <th>Order Status</th>
          <th>Change Order Status</th>
          <th> Payment Status</th> 
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% orders.forEach(order => { %>
          <% order.items.forEach(item => { %>
            <tr>
              <td><%= order.customerId.email %></td>
              <td><%= item.productId.productname %></td>
              <td><%= new Date(order.orderDate).toLocaleDateString() %></td>
              <!-- <td><%= item.quantity %></td>
              <td><%= item.productId.price %></td> -->
              <td><%= Math.floor(order.totalAmount)  %></td>
              <!-- <td><%= order.paymentMethod %></td> -->
    
              <!-- Display Current Order Status -->
              <td>
                <strong>Status:</strong> <%= item.shippingDetails.status %>
              </td>
    
              <td>
                <form action="/admin/update-product-status/<%= order._id %>/<%= item._id %>" method="POST" onsubmit="return confirmStatusChange(event, this)">
                  <select name="status" onchange="return confirmStatusChange(event, this)">
                    <% ['Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled'].forEach(statusOption => { %>
                      <option value="<%= statusOption %>" <%= item.shippingDetails.status === statusOption ? 'selected' : '' %> >
                        <%= statusOption %>
                      </option>
                    <% }); %>
                  </select>
                </form>
              </td>
    
              <td>
                <p>
                  <strong>
                    <%= item.shippingDetails.status === 'Delivered' ? 'Completed' 
                        : item.shippingDetails.status === 'Cancelled' ? 'Failed' 
                        : 'Pending' %>
                  </strong>
                </p>
              </td>
    
              <td>
                <!-- View Button for each product in the order -->
                <a href="/admin/orderview/<%= order._id %>/<%= item.productId._id %>" class="btn btn-info">View</a>
              </td>
            </tr>
          <% }); %>
        <% }); %>
      </tbody>
    </table>
    
  </div>

  <!-- Pagination Controls -->
  <nav aria-label="Order pagination">
    <ul class="pagination">
      <!-- Previous Button -->
      <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
        <a class="page-link" href="/admin/ordermanage?page=<%= currentPage - 1 %>">Previous</a>
      </li>

      <!-- Page Numbers -->
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="/admin/ordermanage?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>

      <!-- Next Button -->
      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="/admin/ordermanage?page=<%= currentPage + 1 %>">Next</a>
      </li>
    </ul>
  </nav>
</div>
</main>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>


function confirmStatusChange(event, form) {
    // Prevent form submission until confirmation
    event.preventDefault();

    // Get the new status value
    const newStatus = form.querySelector('select[name="status"]').value;

    Swal.fire({
      title: "Are you sure?",
      text: `You are about to change the status to "${newStatus}". This action cannot be undone.`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, change status",
      cancelButtonText: "Cancel"
    }).then((result) => {
      if (result.isConfirmed) {
        form.submit(); // Submit the form if confirmed
      }
    });

    return false; // Prevent immediate form submission
  }






  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('categorySearch');
    searchInput.addEventListener('input', function () {
      const searchTerm = searchInput.value.toLowerCase();
      const rows = document.querySelectorAll('tbody tr');
      
      rows.forEach(row => {
        const categoryName = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
        if (categoryName.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  });
</script>

<%- include('../partials/admin/footer') %>
